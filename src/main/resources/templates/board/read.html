<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this::content} )}">

    <th:block th:fragment="content">

        <h1 class="mt-4">Board read page </h1>

        <div class="form-group">
            <label><b>Bno</b></label>
            <input type="text" class="form-control" th:value="${dto.bno}" readonly>
        </div>
        <div class="form-group">
            <label><b>Title</b></label>
            <input type="text"  class="form-control" th:value="${dto.title}" readonly>
        </div>
        <div class="form-group">
            <label><b>Content</b></label>
            <textarea class="form-control"  rows="5" readonly>[[${dto.content}]]</textarea>
        </div>
        <div class="form-group">
            <label><b>Writer</b></label>
            <input type="text" class="form-control"  th:value="${dto.writerName}" readonly>
        </div>
        <div class="form-group">
            <label><b>RegDate</b></label>
            <input type="text" class="form-control"  th:value="${#temporals.format(dto.regDate, 'yyyy/MM/dd HH:mm:ss')}" readonly>
        </div>
        <div class="form-group">
            <label><b>ModDate</b></label>
            <input type="text" class="form-control"  th:value="${#temporals.format(dto.modDate, 'yyyy/MM/dd HH:mm:ss')}" readonly>
        </div>

        <a th:href="@{/board/modify(bno=${dto.bno},page=${requestDTO.page},type=${requestDTO.type},keyword=${requestDTO.keyword})}">
            <button type="button" class="btn btn-primary">Modify</button>
        </a>

        <a th:href="@{/board/list(page=${requestDTO.page},type=${requestDTO.type},keyword=${requestDTO.keyword})}">
            <button type="button" class="btn btn-info">List</button>
        </a>

        <div class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">알림 메시지</h5>

                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="text" class="form-control" name="replyText" placeholder="댓글 입력">
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" name="replier" placeholder="작성자">
                        <input type="hidden" name="rno">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger replyRemove">삭제</button>
                    <button type="button" class="btn btn-warning replyModify">수정</button>
                    <button type="button" class="btn btn-primary replySave">저장</button>
                    <button type="button" class="btn btn-outline-secondary replyClose" data-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
     </div>



        <div>
            <div class="mt-4">
                <h5><span class="badge badge-info addReply"><b>Add Replly</b></span> </h5>
                <h5><span class="badge badge-secondary replyCount">
                    ReplyCount - [[${dto.replyCount}]]
                </span>
            </h5>
            <div class="list-group replyList">

            </div>
            </div>
        </div>
        <script th:inline="javascript">

            $(document).ready(function(){

                var bno =[[${dto.bno}]];
                var modal = $('.modal');
                var listGroup = $(".replyList");
                

                function formatTime(str){

                    var date = new Date(str);

                    return date.getFullYear() + '/' +
                            (date.getMonth()+1) + '/' + 
                            date.getDate() + ' ' +
                            date.getHours() + ':' +
                            date.getMinutes();

                }
                
                function loadJSONData(){
                    $.getJSON('/replies/board/' +bno, function(arr){

                        console.log(arr);
                        var str = " ";

                        $(".replyCount").html("Reply Count - "+arr.length);

                        $.each(arr, function(idx,reply){
                            console.log(reply);

                            str += '<div class="card-body" data-rno="'+reply.rno+'"><b>' + reply.rno + '</b>';
                            str += '<h5 class="card-title">' +reply.text + '</h5>';
                            str += '<h6 class="card-subtitle mb-2 text-muted">'+reply.replier +'</h6>'   ;
                            str += '<p class="card-text">' + formatTime(reply.regDate)+'</p>';
                            str += '</div>';
                        })

                        listGroup.html(str);
                    });
                }   
                
                


                $(".replyCount").click(function(){

                    loadJSONData();
                })

                    // 댓글추가
                 $(".addReply").click(function(){

                    
                    modal.modal('show');

                    $(".input[name='replyText']").val('');
                    $("input[name='replier']").va;('');

                    $(".modal-footer .btn").hide();
                    $(".replySave, .replyClose").show();
                });

                    //댓글저장
                    $(".replySave").click(function(){
                        var reply = {
                            bno : bno,
                            text : $('input[name="replyText"]').val() ,
                            replier : $("input[name='replier']").val()
                        }

                        console.log(reply);

                        $.ajax({
                            url : '/replies/',
                            method: 'post',
                            data: JSON.stringify(reply),
                            contentType: 'application/json; charset=utf-8 ',
                            dataType: 'json',
                            success: function(data){

                                console.log(data);

                                var newRno = parseInt(data);

                                alert(newRno + "번 댓글이 등록되었습니다");
                                modal.modal('hide');
                                loadJSONData();
                            }
                        })
                    });







            })
        </script>
    </th:block>
</th:block>
</html>